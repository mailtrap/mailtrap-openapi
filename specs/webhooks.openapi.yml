openapi: 3.1.0
info:
  title: Webhooks
  version: 2.0.0
  description: |
    Receive real-time notifications about email events and account activities.

    Webhooks allow you to receive all information about your deliverability and activities within your account almost in real-time. Instead of polling for updates, Mailtrap sends HTTP POST requests to your endpoint when events occur.

    {% hint style="info" %}
    For setup instructions and configuration details, see the [Webhooks Guide](https://app.gitbook.com/s/S3xyr7ba7aGO19rc8dSK/email-api-smtp/webhooks).
    {% endhint %}

    ## Event Types

    **Sending Events:**
    - **delivery** - Email successfully delivered
    - **bounce** - Permanent delivery failure
    - **soft bounce** - Temporary failure (will retry)
    - **spam** - Recipient reported spam
    - **unsubscribe** - Recipient unsubscribed
    - **open** - Email was opened
    - **click** - Link was clicked
    - **suspension** - Message suspended
    - **reject** - Message rejected

    **Activity Log Events (Enterprise):**
    - User login events
    - Profile updates
    - Permission changes
    - And more

    ## Payload Formats

    Choose between two formats when configuring your webhook:

    {% tabs %}
    {% tab title="JSON" %}
    Events sent as a JSON object with an `events` array:
    ```json
    {
      "events": [
        {"event": "delivery", "email": "user@example.com", ...}
      ]
    }
    ```
    {% endtab %}

    {% tab title="JSON Lines" %}
    Events sent as newline-delimited JSON:
    ```
    {"event":"delivery","email":"user@example.com",...}
    {"event":"open","email":"user@example.com",...}
    ```
    {% endtab %}
    {% endtabs %}

    ## Processing Webhooks

    - Respond with HTTP **200** to acknowledge receipt
    - Process events asynchronously to avoid timeouts
    - Implement idempotency using `event_id`
    - Handle retries (40 retries every 5 minutes if non-200)
  contact:
    name: Mailtrap Support
    url: 'https://docs.mailtrap.io'
    email: support@mailtrap.io
  license:
    name: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)
    url: 'https://creativecommons.org/licenses/by-sa/4.0/'
  x-logo:
    url: 'https://mailtrap.io/wp-content/uploads/2021/04/mailtrap-logo.svg'

tags:
  - name: json-handler
    x-page-title: JSON Handler
    x-page-icon: brackets-curly
    x-page-description: Handle webhook events in JSON format
    description: |
      Receive webhook events as a JSON object containing an array of events.

      Set **Payload format: JSON** in your webhook settings.

  - name: jsonlines-handler
    x-page-title: JSON Lines Handler
    x-page-icon: list
    x-page-description: Handle webhook events in JSON Lines format
    description: |
      Receive webhook events in [JSON Lines](https://jsonlines.org/) format - one JSON object per line.

      Set **Payload format: JSON Lines** in your webhook settings.

webhooks:
  receiveEventsJSON:
    post:
      summary: Receive events (JSON)
      description: |
        Mailtrap sends a `POST` request to your webhook URL with events as a JSON object.

        **Your endpoint should:**
        - Accept `Content-Type: application/json`
        - Return HTTP 200 to acknowledge receipt
        - Process events asynchronously

        [Webhook setup guide](https://app.gitbook.com/s/S3xyr7ba7aGO19rc8dSK/email-api-smtp/webhooks)
      operationId: receiveEventsJSON
      tags:
        - json-handler
      x-codeSamples:
        - lang: javascript
          label: 'Node.js'
          source: |
            // Express.js webhook handler
            app.post('/webhook', express.json(), (req, res) => {
              const { events } = req.body;

              events.forEach(event => {
                switch(event.event) {
                  case 'delivery':
                    console.log(`Delivered to ${event.email}`);
                    break;
                  case 'bounce':
                    console.log(`Bounced: ${event.response}`);
                    // Add to suppression list
                    break;
                  case 'open':
                    console.log(`Opened by ${event.email}`);
                    break;
                  case 'click':
                    console.log(`Clicked: ${event.url}`);
                    break;
                }
              });

              res.status(200).send('OK');
            });
        - lang: python
          label: 'Python'
          source: |
            from flask import Flask, request

            app = Flask(__name__)

            @app.route('/webhook', methods=['POST'])
            def handle_webhook():
                data = request.get_json()

                for event in data.get('events', []):
                    event_type = event.get('event')

                    if event_type == 'delivery':
                        print(f"Delivered to {event['email']}")
                    elif event_type == 'bounce':
                        print(f"Bounced: {event.get('response')}")
                    elif event_type == 'open':
                        print(f"Opened by {event['email']}")
                    elif event_type == 'click':
                        print(f"Clicked: {event.get('url')}")

                return 'OK', 200
        - lang: php
          label: 'PHP'
          source: |
            <?php
            $payload = file_get_contents('php://input');
            $data = json_decode($payload, true);

            foreach ($data['events'] as $event) {
                switch ($event['event']) {
                    case 'delivery':
                        error_log("Delivered to " . $event['email']);
                        break;
                    case 'bounce':
                        error_log("Bounced: " . $event['response']);
                        break;
                    case 'open':
                        error_log("Opened by " . $event['email']);
                        break;
                    case 'click':
                        error_log("Clicked: " . $event['url']);
                        break;
                }
            }

            http_response_code(200);
            echo 'OK';
        - lang: ruby
          label: 'Ruby'
          source: |
            # Rails controller
            class WebhooksController < ApplicationController
              skip_before_action :verify_authenticity_token

              def mailtrap
                events = params[:events] || []

                events.each do |event|
                  case event[:event]
                  when 'delivery'
                    Rails.logger.info "Delivered to #{event[:email]}"
                  when 'bounce'
                    Rails.logger.info "Bounced: #{event[:response]}"
                  when 'open'
                    Rails.logger.info "Opened by #{event[:email]}"
                  when 'click'
                    Rails.logger.info "Clicked: #{event[:url]}"
                  end
                end

                head :ok
              end
            end
        - lang: csharp
          label: 'C#'
          source: |
            // ASP.NET Core controller
            [ApiController]
            [Route("[controller]")]
            public class WebhookController : ControllerBase
            {
                [HttpPost]
                public IActionResult Handle([FromBody] WebhookPayload payload)
                {
                    foreach (var evt in payload.Events)
                    {
                        switch (evt.Event)
                        {
                            case "delivery":
                                Console.WriteLine($"Delivered to {evt.Email}");
                                break;
                            case "bounce":
                                Console.WriteLine($"Bounced: {evt.Response}");
                                break;
                        }
                    }
                    return Ok();
                }
            }
        - lang: java
          label: 'Java'
          source: |
            // Spring Boot controller
            @RestController
            public class WebhookController {
                @PostMapping("/webhook")
                public String handle(@RequestBody Map<String, Object> payload) {
                    List<Map<String, Object>> events =
                        (List<Map<String, Object>>) payload.get("events");

                    for (Map<String, Object> event : events) {
                        String type = (String) event.get("event");
                        switch (type) {
                            case "delivery":
                                System.out.println("Delivered to " + event.get("email"));
                                break;
                            case "bounce":
                                System.out.println("Bounced: " + event.get("response"));
                                break;
                        }
                    }
                    return "OK";
                }
            }
      requestBody:
        description: Batch of events in JSON format
        content:
          application/json:
            schema:
              type: object
              properties:
                events:
                  type: array
                  items:
                    oneOf:
                      - $ref: '#/components/schemas/SendingWebhookEvent'
                      - $ref: '#/components/schemas/ActivityLogWebhookEvent'
            examples:
              'Delivery':
                description: Email delivered successfully
                value:
                  events:
                    - event: delivery
                      timestamp: 1728669700
                      sending_stream: transactional
                      category: Password reset
                      custom_variables:
                        user_id: "123"
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      sending_domain_name: examplesender.com
              'Bounce':
                description: Permanent delivery failure
                value:
                  events:
                    - event: bounce
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      response: '[CS01] Message rejected due to local policy'
                      response_code: 555
                      bounce_category: spam
                      sending_domain_name: examplesender.com
              'Soft Bounce':
                description: Temporary failure (will retry)
                value:
                  events:
                    - event: soft bounce
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      response: '4.7.1 Temporary error, please retry'
                      response_code: 451
                      bounce_category: greylisting
                      sending_domain_name: examplesender.com
              'Spam':
                description: User reported as spam
                value:
                  events:
                    - event: spam
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      sending_domain_name: examplesender.com
              'Suspension':
                description: Message suspended (rate limit, verification)
                value:
                  events:
                    - event: suspension
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      reason: Your account has reached its daily sending limit.
                      sending_domain_name: examplesender.com
              'Reject':
                description: Message rejected (suppressed, billing)
                value:
                  events:
                    - event: reject
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      reason: 'Recipient in suppression list. Reason: unsubscription'
                      sending_domain_name: examplesender.com
              'Open':
                description: Email was opened
                value:
                  events:
                    - event: open
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      ip: 127.138.158.185
                      user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)'
                      sending_domain_name: examplesender.com
              'Click':
                description: Link was clicked
                value:
                  events:
                    - event: click
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      ip: 142.86.27.2
                      user_agent: 'Mozilla/5.0 (Windows NT x.y; Win64; x64)'
                      url: 'https://mailtrap.io/email-api'
                      sending_domain_name: examplesender.com
              'Unsubscribe':
                description: Recipient unsubscribed
                value:
                  events:
                    - event: unsubscribe
                      timestamp: 1728669700
                      sending_stream: transactional
                      message_id: 1df37d17-0286-4d8b-8edf-bc4ec5be86e6
                      email: receiver@example.com
                      event_id: bede7236-2284-43d6-a953-1fdcafd0fdbc
                      sending_domain_name: examplesender.com
              'Activity Log: User Login':
                value:
                  events:
                    - event: activity_log.user.login
                      description: logged in with SSO
                      actor:
                        id: 1
                        type: user
                        name: John Doe
                      timestamp: 1735830138
              'Activity Log: Profile Update':
                value:
                  events:
                    - event: activity_log.user.updated
                      description: updated the user profile
                      actor:
                        id: 1
                        type: user
                        name: John Doe
                      resource:
                        id: '1'
                        type: user
                        name: John Doe
                      changes:
                        name:
                          from: John
                          to: John Doe
                      timestamp: 1735830138
      responses:
        '200':
          description: Return 200 to acknowledge successful receipt
        '500':
          description: Any other status triggers retry (40 retries every 5 min)

  receiveEventsJSONLines:
    post:
      summary: Receive events (JSON Lines)
      description: |
        Mailtrap sends a `POST` request to your webhook URL with events in [JSON Lines](https://jsonlines.org/) format.

        Each line is a separate JSON object. Parse line by line.

        **Your endpoint should:**
        - Accept `Content-Type: application/jsonl`
        - Return HTTP 200 to acknowledge receipt
        - Process events asynchronously

        [Webhook setup guide](https://app.gitbook.com/s/S3xyr7ba7aGO19rc8dSK/email-api-smtp/webhooks)
      operationId: receiveEventsJSONLines
      tags:
        - jsonlines-handler
      x-codeSamples:
        - lang: javascript
          label: 'Node.js'
          source: |
            // Express.js handler for JSON Lines
            app.post('/webhook', express.text({ type: '*/*' }), (req, res) => {
              const lines = req.body.split('\n').filter(line => line.trim());

              lines.forEach(line => {
                const event = JSON.parse(line);

                switch(event.event) {
                  case 'delivery':
                    console.log(`Delivered to ${event.email}`);
                    break;
                  case 'bounce':
                    console.log(`Bounced: ${event.response}`);
                    break;
                }
              });

              res.status(200).send('OK');
            });
        - lang: python
          label: 'Python'
          source: |
            from flask import Flask, request
            import json

            app = Flask(__name__)

            @app.route('/webhook', methods=['POST'])
            def handle_webhook():
                lines = request.data.decode('utf-8').strip().split('\n')

                for line in lines:
                    event = json.loads(line)
                    event_type = event.get('event')

                    if event_type == 'delivery':
                        print(f"Delivered to {event['email']}")
                    elif event_type == 'bounce':
                        print(f"Bounced: {event.get('response')}")

                return 'OK', 200
        - lang: php
          label: 'PHP'
          source: |
            <?php
            $payload = file_get_contents('php://input');
            $lines = explode("\n", trim($payload));

            foreach ($lines as $line) {
                if (empty($line)) continue;
                $event = json_decode($line, true);

                switch ($event['event']) {
                    case 'delivery':
                        error_log("Delivered to " . $event['email']);
                        break;
                    case 'bounce':
                        error_log("Bounced: " . $event['response']);
                        break;
                }
            }

            http_response_code(200);
            echo 'OK';
      requestBody:
        description: Events in JSON Lines format (one JSON object per line)
        content:
          application/jsonl:
            schema:
              oneOf:
                - $ref: '#/components/schemas/SendingWebhookEvent'
                - $ref: '#/components/schemas/ActivityLogWebhookEvent'
            examples:
              'Delivery events':
                value: |-
                  {"event":"delivery","timestamp":1728669927,"sending_stream":"transactional","category":"Password reset","message_id":"1df37d17-0286-4d8b-8edf-bc4ec5be86e6","email":"receiver@example.com","event_id":"bede7236-2284-43d6-a953-1fdcafd0fdbc","sending_domain_name":"examplesender.com"}
                  {"event":"delivery","timestamp":1728669927,"sending_stream":"transactional","category":"Email confirmation","message_id":"ca7974af-7212-42aa-99fb-cc4742d0658b","email":"another@example.com","event_id":"657b8544-6a95-4c47-997f-6e47922a5052","sending_domain_name":"examplesender.com"}
              'Bounce events':
                value: |-
                  {"event":"bounce","timestamp":1728669927,"sending_stream":"transactional","message_id":"1df37d17-0286-4d8b-8edf-bc4ec5be86e6","email":"receiver@example.com","event_id":"bede7236-2284-43d6-a953-1fdcafd0fdbc","response":"[CS01] Message rejected","response_code":555,"bounce_category":"spam","sending_domain_name":"examplesender.com"}
              'Mixed events':
                value: |-
                  {"event":"delivery","timestamp":1728669927,"message_id":"abc-123","email":"user1@example.com","event_id":"evt-1","sending_stream":"transactional","sending_domain_name":"example.com"}
                  {"event":"open","timestamp":1728669930,"message_id":"abc-123","email":"user1@example.com","event_id":"evt-2","sending_stream":"transactional","ip":"192.168.1.1","sending_domain_name":"example.com"}
                  {"event":"click","timestamp":1728669935,"message_id":"abc-123","email":"user1@example.com","event_id":"evt-3","sending_stream":"transactional","url":"https://example.com","sending_domain_name":"example.com"}
      responses:
        '200':
          description: Return 200 to acknowledge successful receipt
        '500':
          description: Any other status triggers retry (40 retries every 5 min)

components:
  schemas:
    SendingWebhookEvent:
      type: object
      title: SendingWebhookEvent
      description: Email lifecycle webhook event
      required:
        - event
        - message_id
        - sending_stream
        - email
        - timestamp
        - event_id
        - sending_domain_name
      properties:
        event:
          type: string
          enum:
            - delivery
            - open
            - click
            - unsubscribe
            - spam
            - soft bounce
            - bounce
            - suspension
            - reject
          description: Event type
        message_id:
          type: string
          description: Unique message ID
        sending_stream:
          type: string
          enum:
            - transactional
            - bulk
          description: Sending stream used
        email:
          type: string
          description: Recipient email address
        sending_domain_name:
          type: string
          description: Sending domain name
        category:
          type: string
          description: Category assigned when sending
        custom_variables:
          type: object
          description: Custom variables from the email
          additionalProperties:
            type:
              - string
              - number
              - boolean
        timestamp:
          type: integer
          description: Unix epoch timestamp
        event_id:
          type: string
          description: Unique event ID (use for idempotency)
        reason:
          type: string
          description: Reason (for `suspension` and `reject` events)
        response:
          type: string
          description: Server response (for `soft bounce` and `bounce` events)
        response_code:
          type: integer
          description: SMTP response code (for `soft bounce` and `bounce` events)
        bounce_category:
          type: string
          description: Bounce category (for `soft bounce` and `bounce` events)
        ip:
          type: string
          description: User IP address (for `open`, `click`, `unsubscribe` events)
        user_agent:
          type: string
          description: User agent (for `open`, `click`, `unsubscribe` events)
        url:
          type: string
          description: Clicked URL (for `click` events)

    ActivityLogWebhookEvent:
      title: ActivityLogWebhookEvent
      type: object
      description: Account activity webhook event (Enterprise only)
      required:
        - event
        - description
        - actor
        - timestamp
      properties:
        event:
          type: string
          example: activity_log.user.updated
          description: Activity log event type
        description:
          type: string
          description: User-friendly event description
          example: updated the user profile
        actor:
          type: object
          description: User or system that performed the action
          properties:
            id:
              type: integer
              description: Actor ID
              example: 1
            type:
              type: string
              enum:
                - user
                - api_token
              description: Actor type
            name:
              type: string
              description: Actor name
              example: John Doe
        resource:
          type: object
          description: Affected resource (optional)
          properties:
            id:
              type: string
              description: Resource ID
              example: '1'
            type:
              type: string
              enum:
                - user
                - api_token
                - billing
                - account
                - sso_config
                - sending_domain
                - project
                - inbox
                - contact_list
                - contact_field
                - contact_segment
              description: Resource type
            name:
              type: string
              description: Resource name
              example: John Doe
        changes:
          type: object
          description: Changes made (optional)
          example:
            name:
              from: John
              to: John Doe
          additionalProperties:
            type: object
            properties:
              from:
                description: Previous value
              to:
                description: New value
        timestamp:
          type: integer
          description: Unix epoch timestamp
          example: 1735830138
